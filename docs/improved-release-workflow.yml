name: Release and Publish to NPM

on:
  push:
    branches:
      - main
    paths:
      - ".changeset/*.md"
      - "packages/*/package.json"
      - "packages/*/src/**"
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

permissions:
  id-token: write
  contents: write
  pull-requests: write
  packages: write

jobs:
  # æ„å»ºå’Œæµ‹è¯•ä½œä¸š
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: |
          # å°è¯•ä½¿ç”¨frozen-lockfileï¼Œå¦‚æœå¤±è´¥åˆ™æ›´æ–°é”å®šæ–‡ä»¶
          if ! pnpm install --frozen-lockfile; then
            echo "âš ï¸ Lockfile is outdated, updating dependencies..."
            pnpm install
            echo "ğŸ“ Lockfile has been updated"
          fi

      - name: Build packages
        run: pnpm run build

      - name: Run tests
        run: pnpm run test --if-present

  # å‘å¸ƒä½œä¸š
  release:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: |
          # å°è¯•ä½¿ç”¨frozen-lockfileï¼Œå¦‚æœå¤±è´¥åˆ™æ›´æ–°é”å®šæ–‡ä»¶
          if ! pnpm install --frozen-lockfile; then
            echo "âš ï¸ Lockfile is outdated, updating dependencies..."
            pnpm install
            echo "ğŸ“ Lockfile has been updated"
          fi

      - name: Build packages
        run: pnpm run build

      # æ£€æŸ¥æ˜¯å¦æœ‰changesetæ–‡ä»¶
      - name: Check for changesets
        id: check-changesets
        run: |
          if [ -n "$(ls .changeset/*.md 2>/dev/null | grep -v README.md)" ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Found changesets, proceeding with release"
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changesets found"
          fi

      # ä½¿ç”¨ Changesets Action è‡ªåŠ¨åŒ–å‘å¸ƒ
      - name: Create Release PR or publish to npm
        id: changesets
        if: steps.check-changesets.outputs.has_changesets == 'true'
        uses: changesets/action@v1
        with:
          createGithubReleases: true
          publish: pnpm changeset publish
          version: pnpm changeset version
          title: "chore: release packages"
          commit: "chore: release packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      # æ‰‹åŠ¨è§¦å‘å‘å¸ƒï¼ˆå½“workflow_dispatchæ—¶ï¼‰
      - name: Manual release
        if: github.event_name == 'workflow_dispatch' && steps.check-changesets.outputs.has_changesets == 'false'
        run: |
          echo "ğŸš€ Creating manual changeset for ${{ github.event.inputs.release_type }} release"
          pnpm changeset add --empty
          pnpm changeset version
          pnpm changeset publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      # æ‰“å°å‘å¸ƒä¿¡æ¯
      - name: Print release information
        if: steps.changesets.outputs.published == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ‰ Packages published successfully!"
          echo "Published packages:"
          if [ -f ".changeset/published-packages.json" ]; then
            cat .changeset/published-packages.json
          fi
          
          echo ""
          echo "ğŸ“¦ Package versions on NPM:"
          echo "UI: $(npm show @tinyflow-ai/ui version 2>/dev/null || echo 'Not found')"
          echo "React: $(npm show @tinyflow-ai/react version 2>/dev/null || echo 'Not found')"
          echo "Vue: $(npm show @tinyflow-ai/vue version 2>/dev/null || echo 'Not found')"
          echo "Svelte: $(npm show @tinyflow-ai/svelte version 2>/dev/null || echo 'Not found')"

      # å‘å¸ƒå¤±è´¥æ—¶çš„å¤„ç†
      - name: Handle publish failure
        if: failure()
        run: |
          echo "âŒ Publishing failed. Please check the logs above."
          echo "Common issues:"
          echo "1. NPM_TOKEN secret not set or expired"
          echo "2. Package version already exists"
          echo "3. Build or test failures"
          echo "4. Network connectivity issues"
          echo "5. Lockfile synchronization issues"
          echo ""
          echo "ğŸ’¡ To fix lockfile issues:"
          echo "  pnpm install"
          echo "  git add pnpm-lock.yaml"
          echo "  git commit -m 'fix: update lockfile'"
